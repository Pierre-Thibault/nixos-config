#!/usr/bin/env bash

# Show a rofi menu to select and focus a window of the current application
# Usage: select_app_window_niri [--all]
# --all: Show all windows on workspace instead of just current app

# Get the currently focused workspace ID
current_workspace=$(niri msg --json workspaces | jq -r '.[] | select(.is_focused) | .id')

# Check if --all flag is provided
if [ "$1" = "--all" ]; then
    # Get all windows on current workspace
    windows_json=$(niri msg --json windows | jq -r ".[] | select(.workspace_id == $current_workspace)")
else
    # Get the currently focused window and its app_id
    focused_window=$(niri msg --json windows | jq -r '.[] | select(.is_focused)')
    focused_app_id=$(echo "$focused_window" | jq -r '.app_id')

    if [ -z "$focused_app_id" ] || [ "$focused_app_id" = "null" ]; then
        notify-send "No window currently focused"
        exit 1
    fi

    # Get all windows with the same app_id on current workspace
    windows_json=$(niri msg --json windows | jq -r ".[] | select(.app_id == \"$focused_app_id\") | select(.workspace_id == $current_workspace)")
fi

if [ -z "$windows_json" ]; then
    exit 0
fi

# Build the rofi menu with window titles, icons and IDs
menu=""
declare -A window_map

while IFS= read -r window; do
    id=$(echo "$window" | jq -r '.id')
    title=$(echo "$window" | jq -r '.title')
    app_id=$(echo "$window" | jq -r '.app_id')

    # Add to menu with icon metadata (rofi format: title\0icon\x1ficon_name)
    if [ -n "$menu" ]; then
        menu="$menu\n"
    fi
    menu="$menu${title}\0icon\x1f${app_id}"

    # Store mapping of title to id
    window_map["$title"]="$id"
done < <(echo "$windows_json" | jq -c '.')

# Show rofi menu with icons
selected=$(echo -e "$menu" | rofi -dmenu -i -show-icons -p "Choisir une fenÃªtre")

# Focus the selected window
if [ -n "$selected" ]; then
    window_id="${window_map[$selected]}"
    if [ -n "$window_id" ]; then
        niri msg action focus-window --id "$window_id"
    fi
fi
